<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AVA ‚Äî Formulario Permisos Guerrero</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet"/>
<!--
  reCAPTCHA v3 ‚Äî Site Key: 6Lc9zGUsAAAAAG2K5TAav3VrS9obGfFqXO5cnOkV
  El token se genera en el frontend y se env√≠a junto con el formulario.
  La verificaci√≥n del score se realiza en el servidor (FormSubmit lo recibe).
  Tokens expiran en 2 minutos ‚Äî se ejecuta justo antes de enviar el form.
-->
<script src="https://www.google.com/recaptcha/api.js?render=6Lc9zGUsAAAAAG2K5TAav3VrS9obGfFqXO5cnOkV" async defer></script>

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --navy:#0A1F44; --blue:#165DFF; --blue-l:#3a76ff;
  --white:#fff; --dark:#333; --gray:#6B7280;
  --gray-l:#F4F6FA; --border:#D8E0F0;
  --ok:#10B981; --warn:#F59E0B; --err:#EF4444;
  --r:12px; --sh:0 4px 24px rgba(10,31,68,.10); --sh2:0 8px 40px rgba(10,31,68,.18);
}
body{font-family:'DM Sans',sans-serif;background:#EEF2FB;color:var(--dark);min-height:100vh}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{background:var(--navy);padding:28px 20px 24px;text-align:center;position:relative;overflow:hidden}
header::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 50% -10%,rgba(22,93,255,.35) 0%,transparent 70%)}
.logo{font-family:'Outfit',sans-serif;font-size:42px;font-weight:700;color:#fff;letter-spacing:-1px;position:relative}
.logo span{color:var(--blue)}
.subtitle{font-family:'Outfit',sans-serif;font-size:11px;font-weight:500;letter-spacing:4px;color:rgba(255,255,255,.65);text-transform:uppercase;margin-top:4px;position:relative}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
main{max-width:780px;margin:32px auto 80px;padding:0 16px}
.progress-wrap{background:#fff;border-radius:14px;box-shadow:var(--sh);padding:16px 24px;margin-bottom:20px;display:flex;align-items:center;gap:14px}
.prog-bg{flex:1;background:#E5E9F5;border-radius:999px;height:8px;overflow:hidden}
.prog-fill{height:100%;border-radius:999px;background:var(--blue);transition:width .4s,background .3s}
.prog-label{font-size:13px;font-weight:600;color:var(--navy);white-space:nowrap}
.card{background:#fff;border-radius:18px;box-shadow:var(--sh);margin-bottom:20px;overflow:hidden}
.card-hd{background:var(--navy);padding:14px 24px;display:flex;align-items:center;gap:10px}
.card-hd-ico{width:32px;height:32px;background:rgba(22,93,255,.25);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.card-hd h2{font-family:'Outfit',sans-serif;font-size:14px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:#fff}
.card-bd{padding:28px 24px;display:flex;flex-direction:column;gap:18px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
@media(max-width:580px){.grid-2{grid-template-columns:1fr}}

/* ‚îÄ‚îÄ FIELD ‚îÄ‚îÄ */
.field{display:flex;flex-direction:column;gap:6px}
.field label{font-size:12px;font-weight:600;color:var(--navy);letter-spacing:.5px;text-transform:uppercase}
.req{color:var(--blue);margin-left:2px}
.helper{font-size:11px;color:var(--gray);margin-top:2px;line-height:1.5}
.ferr{font-size:11px;color:var(--err);font-weight:500;margin-top:2px;display:none}
.ferr.on{display:block}

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
input[type=text],input[type=email],input[type=date]{
  width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--r);
  font-family:'DM Sans',sans-serif;font-size:14px;color:var(--dark);background:#fff;
  outline:none;transition:border-color .2s,box-shadow .2s;appearance:none;-webkit-appearance:none
}
input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(22,93,255,.10)}
input.vi{border-color:var(--err)!important}
input.vok{border-color:var(--ok)!important}

/* ‚îÄ‚îÄ CUSTOM SELECT (panel viewport-aware) ‚îÄ‚îÄ */
/* todos los selects del formulario usan este sistema */
.csel{position:relative}
.csel-btn{
  width:100%;display:flex;align-items:center;justify-content:space-between;gap:8px;
  padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--r);
  background:#fff;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;
  color:var(--dark);user-select:none;transition:border-color .2s,box-shadow .2s;text-align:left
}
.csel-btn:hover,.csel-btn.open{border-color:var(--blue);box-shadow:0 0 0 3px rgba(22,93,255,.10)}
.csel-ph{color:#9ca3af}
.csel-val{color:var(--dark)}
.csel-arr{flex-shrink:0;transition:transform .2s}
.csel-btn.open .csel-arr{transform:rotate(180deg)}
/* Panels append to body ‚Äî fixed & viewport-aware */
.csel-veil{display:none;position:fixed;inset:0;z-index:900}
.csel-veil.on{display:block}
.csel-panel{
  display:none;position:fixed;z-index:901;
  background:#fff;border:1.5px solid var(--border);border-radius:var(--r);
  box-shadow:var(--sh2);overflow:hidden;flex-direction:column
}
.csel-panel.on{display:flex}
.csel-srchwrap{padding:10px 12px;border-bottom:1px solid var(--border);flex-shrink:0;background:#fff}
.csel-srchwrap input{width:100%;padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none}
.csel-srchwrap input:focus{border-color:var(--blue)}
.csel-scroll{overflow-y:auto;flex:1}
.csel-grp{padding:7px 14px 3px;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--gray);background:var(--gray-l);position:sticky;top:0;z-index:1}
.csel-opt{padding:11px 16px;cursor:pointer;font-size:14px;color:var(--dark);transition:background .15s;border-bottom:1px solid rgba(216,224,240,.35)}
.csel-opt:last-child{border-bottom:none}
.csel-opt:hover{background:rgba(22,93,255,.07)}
.csel-opt.sel{color:var(--blue);font-weight:600;background:rgba(22,93,255,.05)}

/* ‚îÄ‚îÄ PHONE ‚îÄ‚îÄ */
.phone-row{display:flex;gap:8px}
.lada-wrap{flex-shrink:0}
.lada-btn{
  display:flex;align-items:center;gap:6px;padding:11px 12px;
  border:1.5px solid var(--border);border-radius:var(--r);background:#fff;
  cursor:pointer;white-space:nowrap;min-width:118px;user-select:none;transition:border-color .2s
}
.lada-btn:hover,.lada-btn.open{border-color:var(--blue)}
.lada-code{font-weight:600;font-size:13px;color:var(--navy)}

/* ‚îÄ‚îÄ CP ‚îÄ‚îÄ */
.cp-row{position:relative}
.cp-spin{position:absolute;right:12px;top:50%;transform:translateY(-50%);display:none;align-items:center}
.spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ BRAND ‚îÄ‚îÄ */
.brand-wrap{position:relative}
.brand-sugg{
  position:absolute;top:calc(100% + 2px);left:0;right:0;z-index:300;
  background:#fff;border:1.5px solid var(--border);border-radius:var(--r);
  box-shadow:var(--sh2);max-height:250px;overflow-y:auto;display:none
}
.brand-sugg.on{display:block}
.brand-grp{padding:6px 12px 3px;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--gray);background:var(--gray-l);position:sticky;top:0}
.brand-opt{padding:10px 16px;cursor:pointer;font-size:13px;transition:background .15s}
.brand-opt:hover{background:rgba(22,93,255,.07)}

/* ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ */
.drop-zone{border:2px dashed var(--border);border-radius:var(--r);padding:22px 20px;text-align:center;cursor:pointer;transition:border-color .2s,background .2s;position:relative}
.drop-zone:hover,.drop-zone.drag{border-color:var(--blue);background:rgba(22,93,255,.03)}
.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.drop-icon{font-size:30px;margin-bottom:6px}
.drop-zone p{font-size:13px;color:var(--gray);line-height:1.7}
.docs-box{background:rgba(22,93,255,.04);border:1.5px solid rgba(22,93,255,.15);border-radius:10px;padding:14px 16px;font-size:12px;line-height:1.8}
.docs-box .db-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--navy);display:block;margin-bottom:8px}
.legible-ex{margin-top:10px;display:flex;gap:10px}
.lex{flex:1;border-radius:8px;padding:9px 11px;font-size:11px;line-height:1.6}
.lex.ok{background:#e8faf4;border:1px solid #10B981;color:#065f46}
.lex.bad{background:#fef2f2;border:1px solid #EF4444;color:#991b1b}
.lex .lex-label{font-weight:700;font-size:10px;letter-spacing:.8px;text-transform:uppercase;display:block;margin-bottom:3px}
.file-reqnote{font-size:11px;color:var(--err);font-weight:600;margin-top:6px;display:none}
.stor-wrap{margin-top:14px;display:none}
.stor-info{display:flex;justify-content:space-between;font-size:12px;font-weight:600;margin-bottom:6px}
.stor-bg{background:#E5E9F5;border-radius:999px;height:8px;overflow:hidden}
.stor-fill{height:100%;border-radius:999px;transition:width .4s,background .4s}
.stor-status{font-size:11px;margin-top:5px;display:flex;align-items:center;gap:5px}
.sdot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.file-list{margin-top:10px;display:flex;flex-direction:column;gap:6px}
.fitem{display:flex;align-items:center;gap:10px;background:var(--gray-l);border-radius:8px;padding:9px 12px;font-size:13px}
.fitem-ico{font-size:18px}
.fitem-name{flex:1;color:var(--navy);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fitem-size{color:var(--gray);font-size:12px;flex-shrink:0}
.fitem-del{background:none;border:none;cursor:pointer;color:var(--err);font-size:20px;padding:0 2px;line-height:1;flex-shrink:0;transition:opacity .2s}
.fitem-del:hover{opacity:.7}

/* ‚îÄ‚îÄ DECLARACION ‚îÄ‚îÄ */
.decl-box{
  background:linear-gradient(135deg,rgba(10,31,68,.03),rgba(22,93,255,.04));
  border:1.5px solid rgba(22,93,255,.2);border-radius:var(--r);
  padding:18px 20px;display:flex;gap:14px;align-items:flex-start;
  cursor:pointer;transition:border-color .2s,background .2s;user-select:none
}
.decl-box:hover{border-color:var(--blue)}
.decl-box.checked{border-color:var(--ok);background:linear-gradient(135deg,rgba(16,185,129,.04),rgba(16,185,129,.08))}
.decl-chk{
  width:22px;height:22px;flex-shrink:0;border:2px solid var(--border);border-radius:6px;
  background:#fff;display:flex;align-items:center;justify-content:center;margin-top:2px;
  transition:border-color .2s,background .2s;pointer-events:none
}
.decl-box.checked .decl-chk{border-color:var(--ok);background:var(--ok)}
.decl-mark{display:none;color:#fff;font-size:14px;font-weight:700;line-height:1}
.decl-box.checked .decl-mark{display:block}
.decl-text{font-size:12px;line-height:1.75;color:var(--dark)}
.decl-text strong{color:var(--navy)}
.decl-text em{font-style:normal;color:var(--blue);font-weight:600}
.decl-reqnote{font-size:11px;color:var(--err);font-weight:600;margin-top:6px;display:none}

/* ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ */
.btn-submit{
  width:100%;padding:16px;background:var(--blue);color:#fff;
  font-family:'Outfit',sans-serif;font-size:16px;font-weight:600;letter-spacing:.5px;
  border:none;border-radius:var(--r);cursor:pointer;
  transition:background .2s,transform .1s,box-shadow .2s,opacity .3s;
  box-shadow:0 4px 18px rgba(22,93,255,.35);display:flex;align-items:center;justify-content:center;gap:8px
}
.btn-submit:not(:disabled):hover{background:var(--blue-l);transform:translateY(-1px);box-shadow:0 8px 24px rgba(22,93,255,.42)}
.btn-submit:disabled{opacity:.4;cursor:not-allowed;box-shadow:none}
.recap-note{font-size:11px;color:var(--gray);text-align:center;margin-top:10px;line-height:1.5}
.recap-note a{color:var(--blue);text-decoration:none}

/* ‚îÄ‚îÄ WHATSAPP ‚îÄ‚îÄ */
.wa-btn{position:fixed;bottom:24px;left:24px;z-index:999;width:58px;height:58px;background:#25D366;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(37,211,102,.45);text-decoration:none;transition:transform .2s,box-shadow .2s}
.wa-btn:hover{transform:scale(1.08);box-shadow:0 6px 28px rgba(37,211,102,.55)}
.wa-btn svg{width:30px;height:30px;fill:#fff}

::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">A<span>V</span>A</div>
  <div class="subtitle">Formulario Permisos Guerrero</div>
</header>

<main>

<!-- Progress -->
<div class="progress-wrap">
  <div class="prog-bg"><div class="prog-fill" id="prog" style="width:0%"></div></div>
  <div class="prog-label" id="prog-lbl">Completa todos los campos</div>
</div>

<!--
  FORMSUBMIT AJAX ‚Äî endpoint correcto: https://formsubmit.co/ajax/{email}
  ‚Ä¢ M√©todo: POST con FormData (archivos incluidos)
  ‚Ä¢ NO poner Content-Type en headers ‚Äî el navegador lo pone con boundary correcto
  ‚Ä¢ Respuesta JSON: { "success": "true" } o { "error": "..." }
  ‚Ä¢ _captcha:false desactiva el reCAPTCHA propio de FormSubmit (usamos el nuestro v3)
  ‚Ä¢ Primera vez que se env√≠e llega un correo de verificaci√≥n a info@anpai.com.mx
-->
<form id="ava-form" novalidate>
  <!-- Campos ocultos de FormSubmit -->
  <input type="hidden" name="_subject"  value="Nueva Solicitud ‚Äî AVA Permisos Guerrero"/>
  <input type="hidden" name="_template" value="table"/>
  <input type="hidden" name="_captcha"  value="false"/><!-- Desactivamos el captcha propio; usamos reCAPTCHA v3 -->
  <input type="text"   name="_honey"    style="display:none" tabindex="-1" autocomplete="off"/>
  <!-- Token reCAPTCHA v3 ‚Äî se llena justo antes de enviar -->
  <input type="hidden" name="g-recaptcha-response" id="rc-token"/>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATOS PERSONALES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="card-hd"><div class="card-hd-ico">üë§</div><h2>Datos Personales</h2></div>
    <div class="card-bd">

      <div class="grid-2">
        <div class="field">
          <label>Nombre<span class="req">*</span></label>
          <input type="text" name="nombre" placeholder="Tu nombre" data-r/>
        </div>
        <div class="field">
          <label>Segundo Nombre</label>
          <input type="text" name="segundo_nombre" placeholder="Opcional"/>
        </div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label>Apellido Paterno<span class="req">*</span></label>
          <input type="text" name="apellido" placeholder="Primer apellido" data-r/>
        </div>
        <div class="field">
          <label>Apellido Materno<span class="req">*</span></label>
          <input type="text" name="segundo_apellido" placeholder="Segundo apellido" data-r/>
        </div>
      </div>

      <div class="grid-2">
        <!-- G√©nero ‚Äî custom select -->
        <div class="field">
          <label>G√©nero<span class="req">*</span></label>
          <div class="csel">
            <button type="button" class="csel-btn" id="btn-genero">
              <span class="csel-ph">Selecciona...</span>
              <svg class="csel-arr" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke="#0A1F44" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <input type="hidden" name="genero" id="val-genero" data-r/>
          </div>
        </div>
        <div class="field">
          <label>Fecha de Nacimiento<span class="req">*</span></label>
          <input type="date" name="fecha_nacimiento" id="fecha-nac" data-r/>
        </div>
      </div>

      <!-- CURP -->
      <div class="field">
        <label>CURP<span class="req">*</span></label>
        <input type="text" name="curp" id="f-curp" placeholder="Ej. LOOA800101MMCRNS09" maxlength="18" style="text-transform:uppercase" data-r data-val="curp"/>
        <div class="ferr" id="err-curp">CURP inv√°lida ‚Äî debe tener exactamente 18 caracteres con el formato oficial.</div>
        <div class="helper">4 letras ¬∑ 6 d√≠gitos fecha (AAMMDD) ¬∑ H o M ¬∑ 2 letras estado ¬∑ 3 consonantes ¬∑ 2 d√≠gitos verificadores.</div>
      </div>

      <!-- RFC -->
      <div class="field">
        <label>RFC<span class="req">*</span></label>
        <input type="text" name="rfc" id="f-rfc" placeholder="Ej. XEXX010101000 (persona f√≠sica)" maxlength="13" style="text-transform:uppercase" data-r data-val="rfc"/>
        <div class="ferr" id="err-rfc">RFC inv√°lido ‚Äî persona f√≠sica: 13 caracteres ¬∑ persona moral: 12 caracteres.</div>
        <div class="helper">Persona f√≠sica: 4 letras + fecha AAMMDD + 3 alfanum√©ricos = 13 caracteres. Persona moral: 3 letras + fecha + 3 alfanum√©ricos = 12 caracteres.</div>
      </div>

      <!-- CP + COPOMEX -->
      <div class="field">
        <label>C√≥digo Postal<span class="req">*</span></label>
        <div class="cp-row">
          <input type="text" name="codigo_postal" id="f-cp" placeholder="Ej. 39000" maxlength="5" inputmode="numeric" data-r/>
          <div class="cp-spin" id="cp-spin"><div class="spinner"></div></div>
        </div>
      </div>
      <div id="cp-extra" style="display:none;flex-direction:column;gap:18px">
        <div class="grid-2">
          <div class="field">
            <label>Estado</label>
            <input type="text" id="cp-estado" name="estado" readonly style="background:#f8faff"/>
          </div>
          <div class="field">
            <label>Municipio</label>
            <input type="text" id="cp-municipio" name="municipio" readonly style="background:#f8faff"/>
          </div>
        </div>
        <!-- Colonia ‚Äî custom select -->
        <div class="field">
          <label>Colonia<span class="req">*</span></label>
          <div class="csel">
            <button type="button" class="csel-btn" id="btn-colonia">
              <span class="csel-ph">Selecciona tu colonia...</span>
              <svg class="csel-arr" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke="#0A1F44" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <input type="hidden" name="colonia" id="val-colonia"/>
          </div>
        </div>
      </div>

      <!-- Tel√©fono -->
      <div class="field">
        <label>Tel√©fono<span class="req">*</span></label>
        <div class="phone-row">
          <div class="lada-wrap">
            <div class="lada-btn" id="lada-btn" tabindex="0">
              <span id="lada-flag" style="font-size:18px">üá≤üáΩ</span>
              <span class="lada-code" id="lada-code">+52</span>
              <svg width="10" height="6" viewBox="0 0 10 6" fill="none"><path d="M1 1l4 4 4-4" stroke="#0A1F44" stroke-width="1.5" stroke-linecap="round"/></svg>
            </div>
            <input type="hidden" name="lada" id="val-lada" value="+52"/>
          </div>
          <input type="text" name="telefono" placeholder="N√∫mero telef√≥nico" inputmode="tel" data-r style="flex:1"/>
        </div>
      </div>

      <!-- Email -->
      <div class="field">
        <label>Correo Electr√≥nico<span class="req">*</span></label>
        <input type="email" name="email" placeholder="correo@ejemplo.com" data-r/>
      </div>

    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATOS DEL VEH√çCULO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="card-hd"><div class="card-hd-ico">üöó</div><h2>Datos del Veh√≠culo</h2></div>
    <div class="card-bd">

      <!-- Tipo ‚Äî custom select -->
      <div class="field">
        <label>Tipo de Veh√≠culo<span class="req">*</span></label>
        <div class="csel">
          <button type="button" class="csel-btn" id="btn-tipo">
            <span class="csel-ph">Selecciona...</span>
            <svg class="csel-arr" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke="#0A1F44" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <input type="hidden" name="tipo_vehiculo" id="val-tipo" data-r/>
        </div>
      </div>

      <!-- Marca ‚Äî brand autocomplete (siempre re-abre) -->
      <div class="field">
        <label>Marca<span class="req">*</span></label>
        <div class="brand-wrap">
          <input type="text" name="marca" id="f-marca" placeholder="Escribe o haz clic para seleccionar..." autocomplete="off" data-r/>
          <div class="brand-sugg" id="brand-sugg"></div>
        </div>
      </div>
      <div class="field" id="marca-otro-wrap" style="display:none">
        <label>Especifica la Marca<span class="req">*</span></label>
        <input type="text" name="marca_otro" id="f-marca-otro" placeholder="Nombre de la marca"/>
      </div>

      <div class="grid-2">
        <div class="field">
          <label>Versi√≥n / Trim<span class="req">*</span></label>
          <input type="text" name="version" placeholder="Ej. Limited, Sport, XLE..." data-r/>
        </div>
        <!-- A√±o ‚Äî custom select con buscador -->
        <div class="field">
          <label>A√±o Modelo<span class="req">*</span></label>
          <div class="csel">
            <button type="button" class="csel-btn" id="btn-anio">
              <span class="csel-ph">Selecciona a√±o...</span>
              <svg class="csel-arr" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke="#0A1F44" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <input type="hidden" name="anio_modelo" id="val-anio" data-r/>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label>N√∫mero de Serie (VIN)<span class="req">*</span></label>
          <input type="text" name="num_serie" placeholder="17 caracteres alfanum√©ricos" maxlength="17" style="text-transform:uppercase" data-r/>
          <div class="helper">Se encuentra en el tablero, marco de puerta del conductor o factura.</div>
        </div>
        <div class="field">
          <label>N√∫mero de Motor<span class="req">*</span></label>
          <input type="text" name="num_motor" placeholder="Ej. 4A91T12345" style="text-transform:uppercase" data-r/>
          <div class="helper">Localizado en el bloque del motor o en la factura del veh√≠culo.</div>
        </div>
      </div>

      <div class="field">
        <label>Clave Vehicular<span class="req">*</span></label>
        <input type="text" name="clave_vehicular" placeholder="Ej. 8A9SCAZ5E0001" style="text-transform:uppercase" data-r/>
        <div class="helper">Asignada por el fabricante ‚Äî aparece en la factura o tarjeta de circulaci√≥n.</div>
      </div>

      <!-- Archivos -->
      <div class="field">
        <label>Adjuntar Documentos<span class="req">*</span></label>
        <div class="drop-zone" id="drop-zone">
          <input type="file" id="file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.zip,.rar"/>
          <div class="drop-icon">üìÅ</div>
          <p>Arrastra tus archivos aqu√≠ o <strong style="color:var(--blue)">haz clic para seleccionar</strong></p>
          <p style="font-size:11px;margin-top:5px">Formatos: PDF, JPG, PNG, ZIP, RAR &nbsp;|&nbsp; <strong>L√≠mite total: 5 MB</strong></p>
          <p style="font-size:11px;margin-top:3px;color:var(--warn)">üí° Si tus documentos superan 5 MB, compr√≠melos en un <strong>ZIP o RAR</strong> antes de adjuntar.</p>
        </div>

        <div class="docs-box">
          <span class="db-title">üìã Documentos requeridos</span>
          <div style="margin-bottom:4px">‚úÖ <strong>Factura del veh√≠culo</strong> ‚Äî PDF completo o imagen clara con todos los datos visibles.</div>
          <div>‚úÖ <strong>INE por ambos lados</strong> ‚Äî Frente y reverso; pueden ser dos archivos separados.</div>
          <div style="margin-top:10px;font-size:11px;font-weight:600;color:var(--navy)">‚ö†Ô∏è Todos los documentos deben ser <u>legibles</u> ‚Äî texto e informaci√≥n completamente visible, sin recortes ni borrosidad.</div>
          <div class="legible-ex">
            <div class="lex ok">
              <span class="lex-label">‚úÖ Legible</span>
              Foto n√≠tida, bien iluminada, encuadre completo. Nombre, n√∫mero y fecha se leen con claridad.
            </div>
            <div class="lex bad">
              <span class="lex-label">‚ùå No legible</span>
              Imagen borrosa, oscura, con dedos tapando datos, o recortada. No puede procesarse.
            </div>
          </div>
        </div>

        <div class="file-reqnote" id="file-reqnote">‚ö†Ô∏è Debes adjuntar Factura e INE para continuar.</div>

        <div class="stor-wrap" id="stor-wrap">
          <div class="stor-info">
            <span>Capacidad utilizada</span>
            <span id="stor-txt">0 KB de 5 MB</span>
          </div>
          <div class="stor-bg"><div class="stor-fill" id="stor-bar" style="width:0%;background:var(--ok)"></div></div>
          <div class="stor-status" id="stor-status"></div>
        </div>
        <div class="file-list" id="file-list"></div>
      </div>

    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DECLARACI√ìN JURADA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="card-hd"><div class="card-hd-ico">üìú</div><h2>Declaraci√≥n y Conformidad</h2></div>
    <div class="card-bd">
      <div class="decl-box" id="decl-box" onclick="toggleDecl()">
        <div class="decl-chk"><span class="decl-mark">‚úì</span></div>
        <div>
          <div class="decl-text">
            Bajo protesta de decir verdad, declaro que <strong>toda la informaci√≥n proporcionada en este formulario es ver√≠dica, correcta y completa</strong>, y que los documentos adjuntos son <strong>copias fieles de los originales</strong>, sin alteraciones ni modificaciones de ning√∫n tipo.<br><br>
            Manifiesto que estoy plenamente consciente de que <em>la marcaci√≥n de esta casilla tiene la misma validez jur√≠dica que mi firma aut√≥grafa</em>, de conformidad con las disposiciones aplicables en materia de contrataci√≥n electr√≥nica, aceptando plena responsabilidad legal por la veracidad de lo aqu√≠ declarado.
          </div>
          <div class="decl-reqnote" id="decl-reqnote">‚ö†Ô∏è Debes aceptar la declaraci√≥n para poder enviar tu solicitud.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ENVIAR -->
  <div>
    <button type="submit" class="btn-submit" id="btn-send" disabled>
      <span>‚úâÔ∏è</span> Enviar Solicitud
    </button>
    <!--
      reCAPTCHA v3 ‚Äî branding obligatorio cuando se oculta el badge
      Ref: https://developers.google.com/recaptcha/docs/faq
    -->
    <div class="recap-note">
      Protegido por reCAPTCHA ‚Äî <a href="https://policies.google.com/privacy" target="_blank">Privacidad</a> y <a href="https://policies.google.com/terms" target="_blank">T√©rminos</a> de Google.
    </div>
  </div>

</form>
</main>

<!-- WhatsApp (izquierda) ‚Äî reemplazar NUMERO_WHATSAPP con n√∫mero real -->
<a class="wa-btn" href="https://wa.me/NUMERO_WHATSAPP" target="_blank" title="Contactar por WhatsApp">
  <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
</a>

<!-- Elfsight Chatbot -->
<script src="https://elfsightcdn.com/platform.js" async></script>
<div class="elfsight-app-beb4a331-0ecc-4c09-b401-4d88d35cbf03" data-elfsight-app-lazy></div>

<script>
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONSTANTES Y CONFIGURACI√ìN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// COPOMEX ‚Äî token real del cliente
// Endpoint documentado: GET https://api.copomex.com/query/info_cp/{cp}?token={token}
// Respuesta: Array de objetos [ { error: false, code_error: 0, error_message: null, response: { cp, asentamiento, municipio, estado, ... } } ]
// La API tambi√©n puede devolver el asentamiento como array en modo agrupado ‚Äî ambos formatos est√°n manejados.
const COPOMEX_TOKEN = '36da398a-1848-44f3-a952-06c9bfb02cc8';

// FormSubmit ‚Äî endpoint AJAX correcto: https://formsubmit.co/ajax/{email}
// PASOS PARA ACTIVAR:
//   1. La primera vez que se env√≠e el formulario, FormSubmit enviar√° un email de verificaci√≥n a info@anpai.com.mx
//   2. El destinatario debe hacer clic en el enlace de verificaci√≥n de ese email
//   3. A partir de ese momento el endpoint queda activo permanentemente
// Configuraci√≥n:
//   ‚Ä¢ M√©todo: POST con FormData (multipart, permite adjuntar archivos)
//   ‚Ä¢ Headers: SOLO { 'Accept': 'application/json' } ‚Äî NO fijar Content-Type (el navegador lo gestiona con boundary)
//   ‚Ä¢ Respuesta JSON exitosa: { "success": "true" }
//   ‚Ä¢ _captcha:false desactiva el reCAPTCHA propio de FormSubmit (usamos nuestro reCAPTCHA v3)
const FORMSUBMIT_URL = 'https://formsubmit.co/ajax/info@anpai.com.mx';

// reCAPTCHA v3
// PASOS PARA ACTIVAR:
//   1. Site Key (p√∫blica, usada en el HTML/JS): 6Lc9zGUsAAAAAG2K5TAav3VrS9obGfFqXO5cnOkV  ‚Üê ya configurada
//   2. Secret Key (privada, solo para verificaci√≥n en backend): se obtiene en console.google.com/recaptcha
//   3. IMPORTANTE: reCAPTCHA v3 solo genera un token ‚Äî la verificaci√≥n del score (ej. ‚â• 0.5 = humano)
//      requiere hacer una llamada server-side a: https://www.google.com/recaptcha/api/siteverify
//      con POST: secret={SECRET_KEY}&response={TOKEN}
//   4. FormSubmit recibe el campo g-recaptcha-response pero NO verifica el score autom√°ticamente.
//      Para verificaci√≥n completa necesitar√≠as un backend propio o un servicio como Cloudflare Workers.
//   5. En el contexto actual (formulario est√°tico): el token se genera y env√≠a para registro,
//      pero la validaci√≥n del score queda pendiente de implementaci√≥n backend.
// El script de reCAPTCHA ya est√° cargado en el <head> con el site key correcto.
const RECAPTCHA_SITE_KEY = '6Lc9zGUsAAAAAG2K5TAav3VrS9obGfFqXO5cnOkV';

const MAX_BYTES = 5 * 1024 * 1024; // 5 MB

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LADAS por regi√≥n A‚ÜíZ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const LADAS = [
  { r:'√Åfrica', c:[
    {f:'üá©üáø',n:'Argelia',d:'+213'},{f:'üá¶üá¥',n:'Angola',d:'+244'},{f:'üáßüáØ',n:'Ben√≠n',d:'+229'},
    {f:'üáßüáº',n:'Botsuana',d:'+267'},{f:'üáßüá´',n:'Burkina Faso',d:'+226'},{f:'üáßüáÆ',n:'Burundi',d:'+257'},
    {f:'üá®üáª',n:'Cabo Verde',d:'+238'},{f:'üá®üá≤',n:'Camer√∫n',d:'+237'},{f:'üá®üá´',n:'Centro√°frica',d:'+236'},
    {f:'üá∞üá≤',n:'Comoras',d:'+269'},{f:'üá®üá¨',n:'Congo',d:'+242'},{f:'üá®üáÆ',n:'Costa de Marfil',d:'+225'},
    {f:'üá™üá¨',n:'Egipto',d:'+20'},{f:'üá™üá∑',n:'Eritrea',d:'+291'},{f:'üá∏üáø',n:'Esuatini',d:'+268'},
    {f:'üá™üáπ',n:'Etiop√≠a',d:'+251'},{f:'üá¨üá¶',n:'Gab√≥n',d:'+241'},{f:'üá¨üá≤',n:'Gambia',d:'+220'},
    {f:'üá¨üá≠',n:'Ghana',d:'+233'},{f:'üá¨üá≥',n:'Guinea',d:'+224'},{f:'üá¨üáº',n:'Guinea-Bis√°u',d:'+245'},
    {f:'üá∞üá™',n:'Kenia',d:'+254'},{f:'üá±üá∏',n:'Lesoto',d:'+266'},{f:'üá±üá∑',n:'Liberia',d:'+231'},
    {f:'üá±üáæ',n:'Libia',d:'+218'},{f:'üá≤üá¨',n:'Madagascar',d:'+261'},{f:'üá≤üáº',n:'Malaui',d:'+265'},
    {f:'üá≤üá±',n:'Mal√≠',d:'+223'},{f:'üá≤üá¶',n:'Marruecos',d:'+212'},{f:'üá≤üá∫',n:'Mauricio',d:'+230'},
    {f:'üá≤üá∑',n:'Mauritania',d:'+222'},{f:'üá≤üáø',n:'Mozambique',d:'+258'},{f:'üá≥üá¶',n:'Namibia',d:'+264'},
    {f:'üá≥üá™',n:'N√≠ger',d:'+227'},{f:'üá≥üá¨',n:'Nigeria',d:'+234'},{f:'üá∑üáº',n:'Ruanda',d:'+250'},
    {f:'üá∏üá≥',n:'Senegal',d:'+221'},{f:'üá∏üá±',n:'Sierra Leona',d:'+232'},{f:'üá∏üá¥',n:'Somalia',d:'+252'},
    {f:'üá∏üá©',n:'Sud√°n',d:'+249'},{f:'üá∏üá∏',n:'Sud√°n del Sur',d:'+211'},{f:'üáπüáø',n:'Tanzania',d:'+255'},
    {f:'üáπüá¨',n:'Togo',d:'+228'},{f:'üáπüá≥',n:'T√∫nez',d:'+216'},{f:'üá∫üá¨',n:'Uganda',d:'+256'},
    {f:'üáøüá≤',n:'Zambia',d:'+260'},{f:'üáøüáº',n:'Zimbabue',d:'+263'},
  ]},
  { r:'Am√©rica Central y Caribe', c:[
    {f:'üáßüáø',n:'Belice',d:'+501'},{f:'üá®üá∑',n:'Costa Rica',d:'+506'},{f:'üá®üá∫',n:'Cuba',d:'+53'},
    {f:'üá∏üáª',n:'El Salvador',d:'+503'},{f:'üá¨üáπ',n:'Guatemala',d:'+502'},{f:'üá≠üáπ',n:'Hait√≠',d:'+509'},
    {f:'üá≠üá≥',n:'Honduras',d:'+504'},{f:'üáØüá≤',n:'Jamaica',d:'+1-876'},{f:'üá≥üáÆ',n:'Nicaragua',d:'+505'},
    {f:'üáµüá¶',n:'Panam√°',d:'+507'},{f:'üáµüá∑',n:'Puerto Rico',d:'+1-787'},{f:'üá©üá¥',n:'Rep. Dominicana',d:'+1-809'},
    {f:'üáπüáπ',n:'Trinidad y Tobago',d:'+1-868'},
  ]},
  { r:'Am√©rica del Norte', c:[
    {f:'üá®üá¶',n:'Canad√°',d:'+1'},{f:'üá≤üáΩ',n:'M√©xico',d:'+52'},{f:'üá∫üá∏',n:'Estados Unidos',d:'+1'},
  ]},
  { r:'Am√©rica del Sur', c:[
    {f:'üá¶üá∑',n:'Argentina',d:'+54'},{f:'üáßüá¥',n:'Bolivia',d:'+591'},{f:'üáßüá∑',n:'Brasil',d:'+55'},
    {f:'üá®üá±',n:'Chile',d:'+56'},{f:'üá®üá¥',n:'Colombia',d:'+57'},{f:'üá™üá®',n:'Ecuador',d:'+593'},
    {f:'üá¨üáæ',n:'Guyana',d:'+592'},{f:'üáµüáæ',n:'Paraguay',d:'+595'},{f:'üáµüá™',n:'Per√∫',d:'+51'},
    {f:'üá∏üá∑',n:'Surinam',d:'+597'},{f:'üá∫üáæ',n:'Uruguay',d:'+598'},{f:'üáªüá™',n:'Venezuela',d:'+58'},
  ]},
  { r:'Asia', c:[
    {f:'üá∏üá¶',n:'Arabia Saudita',d:'+966'},{f:'üá¶üá≤',n:'Armenia',d:'+374'},{f:'üá¶üáø',n:'Azerbaiy√°n',d:'+994'},
    {f:'üáßüá≠',n:'Bar√©in',d:'+973'},{f:'üáßüá©',n:'Banglad√©s',d:'+880'},{f:'üáßüá≥',n:'Brun√©i',d:'+673'},
    {f:'üáßüáπ',n:'But√°n',d:'+975'},{f:'üá∞üá≠',n:'Camboya',d:'+855'},{f:'üá®üá≥',n:'China',d:'+86'},
    {f:'üá∞üáµ',n:'Corea del Norte',d:'+850'},{f:'üá∞üá∑',n:'Corea del Sur',d:'+82'},{f:'üá¶üá™',n:'Emiratos √Årabes',d:'+971'},
    {f:'üáµüá≠',n:'Filipinas',d:'+63'},{f:'üá¨üá™',n:'Georgia',d:'+995'},{f:'üáÆüá≥',n:'India',d:'+91'},
    {f:'üáÆüá©',n:'Indonesia',d:'+62'},{f:'üáÆüá∂',n:'Irak',d:'+964'},{f:'üáÆüá∑',n:'Ir√°n',d:'+98'},
    {f:'üáÆüá±',n:'Israel',d:'+972'},{f:'üáØüáµ',n:'Jap√≥n',d:'+81'},{f:'üáØüá¥',n:'Jordania',d:'+962'},
    {f:'üá∞üáø',n:'Kazajist√°n',d:'+7'},{f:'üá∞üá¨',n:'Kirguist√°n',d:'+996'},{f:'üá∞üáº',n:'Kuwait',d:'+965'},
    {f:'üá±üá¶',n:'Laos',d:'+856'},{f:'üá±üáß',n:'L√≠bano',d:'+961'},{f:'üá≤üáæ',n:'Malasia',d:'+60'},
    {f:'üá≤üáª',n:'Maldivas',d:'+960'},{f:'üá≤üá≥',n:'Mongolia',d:'+976'},{f:'üá≤üá≤',n:'Myanmar',d:'+95'},
    {f:'üá≥üáµ',n:'Nepal',d:'+977'},{f:'üá¥üá≤',n:'Om√°n',d:'+968'},{f:'üáµüá∞',n:'Pakist√°n',d:'+92'},
    {f:'üáµüá∏',n:'Palestina',d:'+970'},{f:'üá∂üá¶',n:'Qatar',d:'+974'},{f:'üá∏üá¨',n:'Singapur',d:'+65'},
    {f:'üá∏üáæ',n:'Siria',d:'+963'},{f:'üá±üá∞',n:'Sri Lanka',d:'+94'},{f:'üáπüá≠',n:'Tailandia',d:'+66'},
    {f:'üáπüáº',n:'Taiw√°n',d:'+886'},{f:'üáπüá∑',n:'Turqu√≠a',d:'+90'},{f:'üáªüá≥',n:'Vietnam',d:'+84'},
    {f:'üáæüá™',n:'Yemen',d:'+967'},
  ]},
  { r:'Europa', c:[
    {f:'üá¶üá±',n:'Albania',d:'+355'},{f:'üá©üá™',n:'Alemania',d:'+49'},{f:'üá¶üá©',n:'Andorra',d:'+376'},
    {f:'üá¶üáπ',n:'Austria',d:'+43'},{f:'üáßüáæ',n:'Bielorrusia',d:'+375'},{f:'üáßüá™',n:'B√©lgica',d:'+32'},
    {f:'üáßüá¶',n:'Bosnia y Herzegovina',d:'+387'},{f:'üáßüá¨',n:'Bulgaria',d:'+359'},{f:'üá®üáæ',n:'Chipre',d:'+357'},
    {f:'üá≠üá∑',n:'Croacia',d:'+385'},{f:'üá©üá∞',n:'Dinamarca',d:'+45'},{f:'üá∏üá∞',n:'Eslovaquia',d:'+421'},
    {f:'üá∏üáÆ',n:'Eslovenia',d:'+386'},{f:'üá™üá∏',n:'Espa√±a',d:'+34'},{f:'üá™üá™',n:'Estonia',d:'+372'},
    {f:'üá´üáÆ',n:'Finlandia',d:'+358'},{f:'üá´üá∑',n:'Francia',d:'+33'},{f:'üá¨üá∑',n:'Grecia',d:'+30'},
    {f:'üá≠üá∫',n:'Hungr√≠a',d:'+36'},{f:'üáÆüá™',n:'Irlanda',d:'+353'},{f:'üáÆüá∏',n:'Islandia',d:'+354'},
    {f:'üáÆüáπ',n:'Italia',d:'+39'},{f:'üá±üáª',n:'Letonia',d:'+371'},{f:'üá±üáÆ',n:'Liechtenstein',d:'+423'},
    {f:'üá±üáπ',n:'Lituania',d:'+370'},{f:'üá±üá∫',n:'Luxemburgo',d:'+352'},{f:'üá≤üá∞',n:'Macedonia del Norte',d:'+389'},
    {f:'üá≤üáπ',n:'Malta',d:'+356'},{f:'üá≤üá©',n:'Moldavia',d:'+373'},{f:'üá≤üá®',n:'M√≥naco',d:'+377'},
    {f:'üá≤üá™',n:'Montenegro',d:'+382'},{f:'üá≥üá¥',n:'Noruega',d:'+47'},{f:'üá≥üá±',n:'Pa√≠ses Bajos',d:'+31'},
    {f:'üáµüá±',n:'Polonia',d:'+48'},{f:'üáµüáπ',n:'Portugal',d:'+351'},{f:'üá¨üáß',n:'Reino Unido',d:'+44'},
    {f:'üá®üáø',n:'Rep√∫blica Checa',d:'+420'},{f:'üá∑üá¥',n:'Ruman√≠a',d:'+40'},{f:'üá∑üá∫',n:'Rusia',d:'+7'},
    {f:'üá∏üá≤',n:'San Marino',d:'+378'},{f:'üá∑üá∏',n:'Serbia',d:'+381'},{f:'üá∏üá™',n:'Suecia',d:'+46'},
    {f:'üá®üá≠',n:'Suiza',d:'+41'},{f:'üá∫üá¶',n:'Ucrania',d:'+380'},{f:'üáªüá¶',n:'Vaticano',d:'+39'},
  ]},
  { r:'Ocean√≠a', c:[
    {f:'üá¶üá∫',n:'Australia',d:'+61'},{f:'üá´üáØ',n:'Fiyi',d:'+679'},{f:'üá∏üáß',n:'Islas Salom√≥n',d:'+677'},
    {f:'üá≥üáø',n:'Nueva Zelanda',d:'+64'},{f:'üáµüá¨',n:'Pap√∫a Nueva Guinea',d:'+675'},{f:'üáºüá∏',n:'Samoa',d:'+685'},
    {f:'üáπüá¥',n:'Tonga',d:'+676'},{f:'üáªüá∫',n:'Vanuatu',d:'+678'},
  ]},
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MARCAS A‚ÜíZ por categor√≠a ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const MARCAS = {
  'Chinas':         ['BAIC','BYD','Chery','DFSK','Dongfeng','FAW','Foton','GAC','Geely','Haval','JAC','Jetour','Leapmotor','Maxus','MG','Nio','Ora','Roewe','Saic','Wuling','Xpeng','Zotye'],
  'Coreanas':       ['Genesis','Hyundai','Kia','SsangYong'],
  'Europeas':       ['Alfa Romeo','Aston Martin','Audi','Bentley','BMW','Bugatti','Citro√´n','Ferrari','Fiat','Jaguar','Lamborghini','Land Rover','Lotus','Maserati','McLaren','Mercedes-Benz','MINI','Opel','Pagani','Peugeot','Porsche','Renault','Rolls-Royce','Seat','Skoda','Smart','Vauxhall','Volkswagen','Volvo'],
  'Estadounidenses':['Buick','Cadillac','Chevrolet','Chrysler','Dodge','Ford','GMC','Jeep','Lincoln','RAM','Tesla'],
  'Japonesas':      ['Acura','Daihatsu','Honda','Infiniti','Isuzu','Lexus','Mazda','Mitsubishi','Nissan','Subaru','Suzuki','Toyota','Yamaha'],
  'Otra marca':     ['Otra marca'],
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SISTEMA DE PANELES FLOTANTES (viewport-aware)
   Todos los dropdowns usan position:fixed calculado
   en tiempo real para nunca quedar recortados.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let uploadedFiles = [];
let activePanel = null;

// Velo √∫nico compartido por todos los paneles
const VEIL = document.createElement('div');
VEIL.className = 'csel-veil';
document.body.appendChild(VEIL);
VEIL.addEventListener('click', () => closeAllPanels());

function closeAllPanels() {
  if (activePanel) { activePanel.classList.remove('on'); activePanel = null; }
  VEIL.classList.remove('on');
  document.querySelectorAll('.csel-btn.open,.lada-btn.open').forEach(b => b.classList.remove('open'));
}

function positionPanel(panel, trigger) {
  const r = trigger.getBoundingClientRect();
  const w = Math.min(Math.max(r.width, 240), window.innerWidth - 24);
  const maxH = Math.min(280, window.innerHeight * 0.52);
  panel.style.width  = w + 'px';
  panel.style.maxHeight = maxH + 'px';
  let top  = r.bottom + 4;
  let left = r.left;
  if (top + maxH > window.innerHeight - 8) top = Math.max(8, r.top - maxH - 4);
  if (left + w  > window.innerWidth  - 8) left = Math.max(8, window.innerWidth - w - 8);
  panel.style.top  = top  + 'px';
  panel.style.left = left + 'px';
}

function openPanel(panel, trigger, onOpen) {
  closeAllPanels();
  positionPanel(panel, trigger);
  panel.classList.add('on');
  VEIL.classList.add('on');
  trigger.classList.add('open');
  activePanel = panel;
  if (onOpen) onOpen();
}

// Reposiciona al hacer scroll/resize
window.addEventListener('resize', () => {
  if (activePanel) {
    const t = document.querySelector('.csel-btn.open, .lada-btn.open');
    if (t) positionPanel(activePanel, t);
    else closeAllPanels(); // si no hay trigger visible, cerrar
  }
}, true);
window.addEventListener('scroll', () => {
  if (activePanel) {
    const t = document.querySelector('.csel-btn.open, .lada-btn.open');
    if (t) positionPanel(activePanel, t);
  }
}, {capture:true, passive:true});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê makeCustomSelect ‚Äî crea un select personalizado ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   params:
     btnId     ‚Äî id del bot√≥n .csel-btn
     hiddenId  ‚Äî id del <input type=hidden>
     items     ‚Äî array de strings o [{group, options[]}]
     searchable ‚Äî bool
     onChange  ‚Äî callback(value)
*/
function makeCustomSelect({ btnId, hiddenId, items, searchable = false, onChange }) {
  const btn    = document.getElementById(btnId);
  const hidden = document.getElementById(hiddenId);
  if (!btn || !hidden) return;

  const panel = document.createElement('div');
  panel.className = 'csel-panel';
  panel.id = 'panel-' + btnId;

  let srch = null;
  if (searchable) {
    const sw = document.createElement('div'); sw.className = 'csel-srchwrap';
    srch = document.createElement('input'); srch.type = 'text'; srch.placeholder = 'Buscar...';
    sw.appendChild(srch); panel.appendChild(sw);
  }

  const scroll = document.createElement('div'); scroll.className = 'csel-scroll';
  panel.appendChild(scroll);
  document.body.appendChild(panel);

  function isGrouped(items) { return items.length > 0 && typeof items[0] === 'object' && items[0].group; }

  function buildList(q = '') {
    scroll.innerHTML = '';
    const lq = q.toLowerCase();
    const grouped = isGrouped(items);

    function addOpt(text) {
      if (q && !text.toLowerCase().includes(lq)) return;
      const d = document.createElement('div'); d.className = 'csel-opt';
      if (hidden.value === text) d.classList.add('sel');
      d.textContent = text;
      d.addEventListener('click', () => {
        hidden.value = text;
        btn.innerHTML = `<span class="csel-val">${text}</span><svg class="csel-arr" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke="#0A1F44" stroke-width="2" stroke-linecap="round"/></svg>`;
        closeAllPanels();
        if (onChange) onChange(text);
        checkValidity();
      });
      scroll.appendChild(d);
    }

    if (grouped) {
      items.forEach(({ group, options }) => {
        const shown = options.filter(o => !q || o.toLowerCase().includes(lq));
        if (!shown.length) return;
        const g = document.createElement('div'); g.className = 'csel-grp'; g.textContent = group;
        scroll.appendChild(g);
        shown.forEach(addOpt);
      });
    } else {
      items.forEach(addOpt);
    }
  }

  btn.addEventListener('click', e => {
    e.stopPropagation();
    if (panel.classList.contains('on')) { closeAllPanels(); return; }
    openPanel(panel, btn, () => {
      buildList();
      if (srch) { srch.value = ''; srch.focus(); }
    });
  });
  panel.addEventListener('click', e => e.stopPropagation());
  if (srch) srch.addEventListener('input', () => buildList(srch.value));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('fecha-nac').max = new Date().toISOString().split('T')[0];

  initSelects();
  initLada();
  initCP();
  initBrand();
  initFiles();
  initValidation();
  initSubmit();
  checkValidity();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CUSTOM SELECTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initSelects() {
  // G√©nero
  makeCustomSelect({ btnId:'btn-genero', hiddenId:'val-genero', items:['Masculino','Femenino'] });

  // Tipo veh√≠culo
  makeCustomSelect({ btnId:'btn-tipo', hiddenId:'val-tipo', items:['Nuevo','Seminuevo'] });

  // A√±o modelo
  const years = [];
  const cur = new Date().getFullYear();
  for (let y = cur + 1; y >= 1960; y--) years.push(String(y));
  makeCustomSelect({ btnId:'btn-anio', hiddenId:'val-anio', items: years, searchable: true });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LADA ‚Äî panel viewport-aware
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initLada() {
  const ladaBtn  = document.getElementById('lada-btn');
  const flagEl   = document.getElementById('lada-flag');
  const codeEl   = document.getElementById('lada-code');
  const valInput = document.getElementById('val-lada');

  const panel = document.createElement('div'); panel.className = 'csel-panel'; panel.id = 'panel-lada';
  const sw = document.createElement('div'); sw.className = 'csel-srchwrap';
  const srch = document.createElement('input'); srch.type = 'text'; srch.placeholder = 'Buscar pa√≠s o c√≥digo...';
  sw.appendChild(srch); panel.appendChild(sw);
  const scroll = document.createElement('div'); scroll.className = 'csel-scroll';
  panel.appendChild(scroll);
  document.body.appendChild(panel);

  function build(q = '') {
    scroll.innerHTML = '';
    const lq = q.toLowerCase();
    LADAS.forEach(({ r, c }) => {
      const sorted = [...c].sort((a, b) => a.n.localeCompare(b.n, 'es'));
      const matches = sorted.filter(x => !q || x.n.toLowerCase().includes(lq) || x.d.includes(lq));
      if (!matches.length) return;
      const g = document.createElement('div'); g.className = 'csel-grp'; g.textContent = r;
      scroll.appendChild(g);
      matches.forEach(x => {
        const d = document.createElement('div'); d.className = 'csel-opt';
        d.innerHTML = `<span style="font-size:17px;margin-right:8px">${x.f}</span>${x.n} <span style="color:var(--blue);font-weight:600;margin-left:auto;padding-left:8px">${x.d}</span>`;
        d.style.display = 'flex'; d.style.alignItems = 'center';
        d.addEventListener('click', () => {
          flagEl.textContent = x.f; codeEl.textContent = x.d; valInput.value = x.d;
          closeAllPanels(); checkValidity();
        });
        scroll.appendChild(d);
      });
    });
  }

  ladaBtn.addEventListener('click', e => {
    e.stopPropagation();
    if (panel.classList.contains('on')) { closeAllPanels(); return; }
    openPanel(panel, ladaBtn, () => { srch.value = ''; build(); srch.focus(); });
  });
  ladaBtn.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); ladaBtn.click(); } });
  panel.addEventListener('click', e => e.stopPropagation());
  srch.addEventListener('input', () => build(srch.value));
  build();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COPOMEX
   Endpoint documentado: GET /query/info_cp/{cp}?type=simplified&token={token}
   Respuesta: Array de objetos [ { error, code_error, error_message, response: {
     cp, asentamiento, tipo_asentamiento, municipio, estado, ciudad, pais
   } } ]
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initCP() {
  const cpInput  = document.getElementById('f-cp');
  const spin     = document.getElementById('cp-spin');
  const extra    = document.getElementById('cp-extra');
  const coloniaBtn = document.getElementById('btn-colonia');
  const coloniaVal = document.getElementById('val-colonia');
  let timer;

  cpInput.addEventListener('input', () => {
    clearTimeout(timer);
    const cp = cpInput.value.trim();
    if (cp.length !== 5) { extra.style.display = 'none'; checkValidity(); return; }
    timer = setTimeout(() => fetchCP(cp), 700);
  });

  coloniaVal.addEventListener('change', checkValidity);

  async function fetchCP(cp) {
    spin.style.display = 'flex';
    try {
      // URL correcta seg√∫n documentaci√≥n oficial de COPOMEX v2
      // https://api.copomex.com/query/info_cp/{cp}?token={token}
      // Nota: type=simplified es OPCIONAL ‚Äî omitirlo devuelve el formato est√°ndar con m√°s detalle
      const url = `https://api.copomex.com/query/info_cp/${cp}?token=${COPOMEX_TOKEN}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      // La API devuelve un ARRAY aunque solo haya un resultado
      // Formato: [ { error: false, code_error: 0, error_message: null, response: { cp, asentamiento, tipo_asentamiento, municipio, estado, ciudad, pais } } ]
      const arr = Array.isArray(data) ? data : [data];

      // Filtrar los que no tienen error
      const valid = arr.filter(item => !item.error && item.response);
      if (!valid.length) { extra.style.display = 'none'; return; }

      // Estado y municipio del primer resultado
      const r0 = valid[0].response;
      document.getElementById('cp-estado').value    = r0.estado    || '';
      document.getElementById('cp-municipio').value  = r0.municipio || r0.ciudad || '';

      // Colonias √∫nicas A‚ÜíZ ‚Äî el campo puede llamarse "asentamiento" o "response" contener array
      let colonias = [];
      if (typeof r0.asentamiento === 'string') {
        // Modo simplificado: un asentamiento por objeto
        colonias = [...new Set(valid.map(item => item.response.asentamiento || '').filter(Boolean))].sort();
      } else if (Array.isArray(r0.asentamiento)) {
        // Modo agrupado: el asentamiento es un array dentro del primer response
        colonias = [...new Set(r0.asentamiento.filter(Boolean))].sort();
      } else {
        // Fallback: extraer cualquier string de asentamiento encontrado
        colonias = [...new Set(valid.map(item => item.response.asentamiento || item.response.colonia || '').filter(Boolean))].sort();
      }

      // Resetear colonia
      coloniaVal.value = '';
      coloniaBtn.innerHTML = `<span class="csel-ph">Selecciona tu colonia...</span><svg class="csel-arr" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke="#0A1F44" stroke-width="2" stroke-linecap="round"/></svg>`;

      // Destruir panel anterior de colonia para evitar duplicados de listeners
      const oldPanel = document.getElementById('panel-btn-colonia');
      if (oldPanel) oldPanel.remove();

      // Registrar colonia como select personalizado con las colonias obtenidas
      makeCustomSelect({
        btnId:    'btn-colonia',
        hiddenId: 'val-colonia',
        items:    colonias,
        searchable: colonias.length > 8,
      });

      extra.style.display = 'flex';
    } catch(err) {
      console.error('COPOMEX error:', err);
      extra.style.display = 'none';
    } finally {
      spin.style.display = 'none';
      checkValidity();
    }
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BRAND AUTOCOMPLETE
   Siempre abre el men√∫ al hacer clic o focus,
   incluso si ya hay un valor seleccionado.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initBrand() {
  const input      = document.getElementById('f-marca');
  const sugg       = document.getElementById('brand-sugg');
  const otroWrap   = document.getElementById('marca-otro-wrap');
  const otroInput  = document.getElementById('f-marca-otro');

  function buildSugg(q = '') {
    sugg.innerHTML = '';
    const lq = q.toLowerCase();
    let any = false;
    Object.entries(MARCAS).forEach(([cat, brands]) => {
      const matches = brands.filter(b => !q || b.toLowerCase().includes(lq));
      if (!matches.length) return;
      any = true;
      const g = document.createElement('div'); g.className = 'brand-grp';
      g.textContent = cat === 'Otra marca' ? 'Otra' : `Marcas ${cat}`;
      sugg.appendChild(g);
      matches.forEach(b => {
        const d = document.createElement('div'); d.className = 'brand-opt'; d.textContent = b;
        d.addEventListener('mousedown', e => {
          e.preventDefault();
          input.value = b;
          sugg.classList.remove('on');
          const esOtra = b === 'Otra marca';
          otroWrap.style.display  = esOtra ? 'block' : 'none';
          otroInput.required      = esOtra;
          if (!esOtra) otroInput.value = '';
          checkValidity();
        });
        sugg.appendChild(d);
      });
    });
    sugg.classList.toggle('on', any);
  }

  // Siempre mostrar men√∫ al hacer focus o click (permite re-seleccionar)
  // Usamos flag para evitar que blur cierre el panel antes de que mousedown registre la selecci√≥n
  let brandMouseDown = false;
  sugg.addEventListener('mousedown', () => { brandMouseDown = true; });
  sugg.addEventListener('mouseup',   () => { brandMouseDown = false; });

  input.addEventListener('focus', () => buildSugg(input.value));
  input.addEventListener('click', () => buildSugg(input.value));
  input.addEventListener('input', () => { buildSugg(input.value); checkValidity(); });
  input.addEventListener('blur', () => {
    if (brandMouseDown) return; // No cerrar si el usuario est√° haciendo clic en una opci√≥n
    setTimeout(() => sugg.classList.remove('on'), 180);
  });
  otroInput.addEventListener('input', checkValidity);
  document.addEventListener('click', e => { if (!e.target.closest('.brand-wrap')) sugg.classList.remove('on'); });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FILE UPLOAD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initFiles() {
  const zone = document.getElementById('drop-zone');
  const fi   = document.getElementById('file-input');
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
  zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('drag'); addFiles(e.dataTransfer.files); });
  fi.addEventListener('change', () => { addFiles(fi.files); fi.value = ''; });
}

function addFiles(files) {
  for (const f of files) {
    const used = uploadedFiles.reduce((a, x) => a + x.file.size, 0);
    if (used + f.size > MAX_BYTES) {
      alert(`"${f.name}" supera el l√≠mite de 5 MB total.\nComprime tus documentos en un ZIP/RAR antes de adjuntarlos.`);
      continue;
    }
    uploadedFiles.push({ file: f, id: Date.now() + Math.random() });
  }
  renderFiles(); updateStorage(); checkValidity();
}

window.removeFile = function(id) {
  uploadedFiles = uploadedFiles.filter(x => x.id !== id);
  renderFiles(); updateStorage(); checkValidity();
};

function renderFiles() {
  const list = document.getElementById('file-list');
  list.innerHTML = '';
  uploadedFiles.forEach(({ file, id }) => {
    const ext  = file.name.split('.').pop().toLowerCase();
    const icon = ext === 'pdf' ? 'üìÑ' : ['jpg','jpeg','png'].includes(ext) ? 'üñºÔ∏è' : ['zip','rar'].includes(ext) ? 'üóúÔ∏è' : 'üìÅ';
    const d = document.createElement('div'); d.className = 'fitem';
    d.innerHTML = `<span class="fitem-ico">${icon}</span><span class="fitem-name">${file.name}</span><span class="fitem-size">${fmtB(file.size)}</span><button type="button" class="fitem-del" onclick="removeFile(${id})" title="Eliminar">√ó</button>`;
    list.appendChild(d);
  });
}

function updateStorage() {
  const wrap = document.getElementById('stor-wrap');
  const used = uploadedFiles.reduce((a, x) => a + x.file.size, 0);
  if (!uploadedFiles.length) { wrap.style.display = 'none'; return; }
  wrap.style.display = 'block';
  const pct  = Math.min((used / MAX_BYTES) * 100, 100);
  const left = MAX_BYTES - used;
  document.getElementById('stor-txt').textContent = `${fmtB(used)} de 5 MB`;
  const bar  = document.getElementById('stor-bar');
  bar.style.width = pct + '%';
  let color, msg;
  if (pct >= 100) { color = 'var(--err)';  msg = 'üî¥ L√≠mite alcanzado'; }
  else if (pct >= 75) { color = 'var(--warn)'; msg = `‚ö†Ô∏è Casi lleno ‚Äî quedan ${fmtB(left)}`; }
  else                { color = 'var(--ok)';   msg = `‚úÖ ${fmtB(left)} disponibles`; }
  bar.style.background = color;
  document.getElementById('stor-status').innerHTML = `<span class="sdot" style="background:${color}"></span><span style="font-size:12px;color:${color};font-weight:600">${msg}</span>`;
}

function fmtB(b) {
  if (b >= 1048576) return (b/1048576).toFixed(2)+' MB';
  if (b >= 1024)    return (b/1024).toFixed(1)+' KB';
  return b+' B';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VALIDACI√ìN ‚Äî CURP, RFC, progreso, bot√≥n bloqueado
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// Regex oficiales CURP y RFC M√©xico
const CURP_RE = /^[A-Z]{4}[0-9]{6}[HM][A-Z]{2}[B-DF-HJ-NP-TV-Z]{3}[A-Z0-9]{2}$/;
const RFC_PF  = /^[A-Z√ë&]{4}[0-9]{6}[A-Z0-9]{3}$/;  // Persona f√≠sica ‚Äî 13 chars
const RFC_PM  = /^[A-Z√ë&]{3}[0-9]{6}[A-Z0-9]{3}$/;  // Persona moral  ‚Äî 12 chars

function initValidation() {
  const curp = document.getElementById('f-curp');
  const rfc  = document.getElementById('f-rfc');

  curp.addEventListener('input', () => {
    curp.value = curp.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    const ok = CURP_RE.test(curp.value);
    curp.classList.toggle('vi',  curp.value.length > 0 && !ok);
    curp.classList.toggle('vok', ok);
    document.getElementById('err-curp').classList.toggle('on', curp.value.length > 0 && !ok);
    checkValidity();
  });

  rfc.addEventListener('input', () => {
    rfc.value = rfc.value.toUpperCase().replace(/[^A-Z√ë&0-9]/g, '');
    const ok = RFC_PF.test(rfc.value) || RFC_PM.test(rfc.value);
    rfc.classList.toggle('vi',  rfc.value.length > 0 && !ok);
    rfc.classList.toggle('vok', ok);
    document.getElementById('err-rfc').classList.toggle('on', rfc.value.length > 0 && !ok);
    checkValidity();
  });

  // Adjuntar listeners a todos los campos con data-r
  document.querySelectorAll('[data-r]').forEach(el => {
    el.addEventListener('input', checkValidity);
    el.addEventListener('change', checkValidity);
  });
}

function checkValidity() {
  let total = 0, filled = 0, allOk = true;

  // Campos de texto/email/date con data-r (excluir hidden inputs ‚Äî los manejamos abajo)
  document.querySelectorAll('[data-r]').forEach(el => {
    if (el.type === 'hidden') return; // se cuentan aparte
    if (!el.offsetParent) return;     // skip si oculto por CSS
    total++;
    if (el.value.trim()) filled++; else allOk = false;
  });

  // Hidden inputs de custom selects (G√©nero, Tipo, A√±o, Lada no es required)
  ['val-genero','val-tipo','val-anio'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    total++;
    if (el.value.trim()) filled++; else allOk = false;
  });

  // Colonia ‚Äî solo requerida si el bloque CP est√° visible
  if (document.getElementById('cp-extra').style.display !== 'none') {
    total++;
    const col = document.getElementById('val-colonia');
    if (col && col.value) filled++; else allOk = false;
  }

  // CURP ‚Äî formato v√°lido
  if (!CURP_RE.test(document.getElementById('f-curp').value)) allOk = false;

  // RFC ‚Äî formato v√°lido
  const rfcVal = document.getElementById('f-rfc').value;
  if (!RFC_PF.test(rfcVal) && !RFC_PM.test(rfcVal)) allOk = false;

  // Archivos obligatorios
  total++;
  const fileOk = uploadedFiles.length > 0;
  if (fileOk) filled++; else allOk = false;
  document.getElementById('file-reqnote').style.display = fileOk ? 'none' : 'block';

  // Marca ‚Äî si es "Otra marca" requiere especificar
  const marcaVal = document.getElementById('f-marca').value;
  if (marcaVal === 'Otra marca') {
    if (!document.getElementById('f-marca-otro').value.trim()) allOk = false;
  } else if (!marcaVal.trim()) {
    allOk = false;
  }

  // Declaraci√≥n
  total++;
  const declOk = document.getElementById('decl-box').classList.contains('checked');
  if (declOk) filled++; else allOk = false;
  document.getElementById('decl-reqnote').style.display = declOk ? 'none' : 'block';

  // Barra de progreso
  const pct = total > 0 ? Math.round((filled / total) * 100) : 0;
  const fill = document.getElementById('prog');
  fill.style.width      = pct + '%';
  fill.style.background = pct === 100 ? 'var(--ok)' : 'var(--blue)';
  document.getElementById('prog-lbl').textContent =
    pct === 100 ? '‚úÖ ¬°Todo completo! Listo para enviar.' : `${filled} de ${total} campos completados`;

  document.getElementById('btn-send').disabled = !allOk;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DECLARACI√ìN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleDecl() {
  document.getElementById('decl-box').classList.toggle('checked');
  checkValidity();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ENV√çO DEL FORMULARIO
   
   FormSubmit AJAX ‚Äî configuraci√≥n correcta:
   ‚Ä¢ URL: https://formsubmit.co/ajax/info@anpai.com.mx
   ‚Ä¢ M√©todo: POST
   ‚Ä¢ Body: FormData (con archivos adjuntos)
   ‚Ä¢ Headers: SOLO { 'Accept': 'application/json' }
     ‚Üí NO poner Content-Type; el navegador lo gestiona con boundary
   ‚Ä¢ Respuesta esperada: { "success": "true" }
   ‚Ä¢ NOTA: La primera vez se enviar√° email de verificaci√≥n a info@anpai.com.mx
     ‚Üí Hay que confirmar el correo para activar el endpoint
   
   reCAPTCHA v3:
   ‚Ä¢ Se ejecuta grecaptcha.execute() justo antes de enviar (token v√°lido 2 min)
   ‚Ä¢ El token va en el campo g-recaptcha-response dentro del FormData
   ‚Ä¢ Para verificar el score se necesita backend con Secret Key (fuera del scope del formulario est√°tico)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initSubmit() {
  document.getElementById('ava-form').addEventListener('submit', async e => {
    e.preventDefault();
    const btn = document.getElementById('btn-send');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Enviando solicitud...';

    // 1. Generar token reCAPTCHA v3 justo antes del submit
    try {
      const token = await new Promise((res, rej) => {
        if (typeof grecaptcha !== 'undefined') {
          grecaptcha.ready(() =>
            grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit_permiso' })
              .then(res).catch(rej)
          );
        } else {
          res(''); // Si reCAPTCHA no carg√≥ (ej. bloqueador), continuar sin token
        }
      });
      document.getElementById('rc-token').value = token;
    } catch(err) {
      console.warn('reCAPTCHA no disponible:', err);
    }

    // 2. Construir FormData ‚Äî NUNCA fijar Content-Type manualmente
    const fd = new FormData();

    // Campos especiales de FormSubmit (control fields)
    fd.append('_subject',  'Nueva Solicitud ‚Äî AVA Permisos Guerrero');
    fd.append('_template', 'table');
    fd.append('_captcha',  'false'); // Desactivamos reCAPTCHA propio de FormSubmit; usamos v3 nuestro

    // Honeypot ‚Äî campo anti-spam vac√≠o
    fd.append('_honey', '');

    // Token reCAPTCHA v3
    fd.append('g-recaptcha-response', document.getElementById('rc-token').value);

    // Campos del formulario ‚Äî excluir los campos de control ya a√±adidos y el file input
    // Tambi√©n excluimos _honey para no duplicar
    const SKIP_FIELDS = new Set(['_subject','_template','_captcha','_honey','g-recaptcha-response']);
    const form = document.getElementById('ava-form');
    new FormData(form).forEach((val, key) => {
      if (SKIP_FIELDS.has(key)) return; // ya a√±adidos arriba
      fd.append(key, val);
    });

    // Archivos adjuntos reales (gestionados por JS, no por el input nativo)
    uploadedFiles.forEach(({ file }, i) => {
      fd.append(`adjunto_${i + 1}`, file, file.name);
    });

    // 3. Enviar a FormSubmit AJAX
    // IMPORTANTE: La primera vez que se env√≠e, FormSubmit enviar√° un email de verificaci√≥n
    // a info@anpai.com.mx. Hasta no confirmar ese email el endpoint no funcionar√°.
    // URL correcta para AJAX: https://formsubmit.co/ajax/{email}
    try {
      const res = await fetch(FORMSUBMIT_URL, {
        method: 'POST',
        headers: { 'Accept': 'application/json' },
        // NO poner 'Content-Type' ‚Äî el navegador lo pone con boundary correcto para multipart
        body: fd,
      });

      // FormSubmit a veces devuelve HTML si el email no est√° verificado ‚Äî manejar ambos casos
      const contentType = res.headers.get('content-type') || '';
      let json = {};
      if (contentType.includes('application/json')) {
        json = await res.json();
      } else {
        const text = await res.text();
        // Si la respuesta contiene HTML es probable que sea la p√°gina de verificaci√≥n
        if (text.includes('<!DOCTYPE') || text.includes('<html')) {
          throw new Error('El email info@anpai.com.mx a√∫n no ha sido verificado en FormSubmit. Revisa la bandeja de entrada y confirma el email de activaci√≥n antes de usar el formulario.');
        }
        try { json = JSON.parse(text); } catch { json = { success: res.ok }; }
      }

      if (res.ok && (json.success === 'true' || json.success === true)) {
        // ‚úÖ √âxito
        btn.innerHTML = '‚úÖ ¬°Solicitud enviada correctamente!';
        btn.style.background = 'var(--ok)';
        btn.style.opacity = '1';
        resetForm();
      } else {
        throw new Error(json.message || `HTTP ${res.status} ‚Äî verifica que el correo info@anpai.com.mx est√© confirmado en FormSubmit`);
      }
    } catch(err) {
      console.error('Error al enviar:', err);
      const errMsg = err.message && err.message.length < 120 ? err.message : 'Error al enviar ‚Äî intenta nuevamente';
      btn.innerHTML = `‚ùå ${errMsg}`;
      btn.style.background = 'var(--err)';
      btn.style.opacity = '1';
      btn.disabled = false;
      setTimeout(() => {
        btn.innerHTML = '<span>‚úâÔ∏è</span> Enviar Solicitud';
        btn.style.background = '';
        btn.style.opacity = '';
        checkValidity();
      }, 5000);
    }
  });
}

function resetForm() {
  document.getElementById('ava-form').reset();
  uploadedFiles = [];
  document.getElementById('file-list').innerHTML = '';
  document.getElementById('stor-wrap').style.display = 'none';
  document.getElementById('cp-extra').style.display  = 'none';
  document.getElementById('marca-otro-wrap').style.display = 'none';
  document.getElementById('decl-box').classList.remove('checked');

  // Resetear custom selects (botones)
  const resetBtn = (id, ph) => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = `<span class="csel-ph">${ph}</span><svg class="csel-arr" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke="#0A1F44" stroke-width="2" stroke-linecap="round"/></svg>`;
  };
  resetBtn('btn-genero',  'Selecciona...');
  resetBtn('btn-tipo',    'Selecciona...');
  resetBtn('btn-anio',    'Selecciona a√±o...');
  resetBtn('btn-colonia', 'Selecciona tu colonia...');

  document.querySelectorAll('input[type=hidden][id^="val-"]').forEach(el => el.value = '');
  document.getElementById('val-lada').value = '+52';
  document.getElementById('lada-flag').textContent = 'üá≤üáΩ';
  document.getElementById('lada-code').textContent = '+52';

  checkValidity();
}
</script>
</body>
</html>
